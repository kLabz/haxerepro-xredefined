#
- echo "Trigger first error that leads to X redefined from X"
- echo "----------------------------------------------------"
- root "/git/haxe-libs/haxeserver/repro/xredefined"
- abortOnFailure

- start

# Comment this out when working with vshaxe cache view, since it's doing the
# cache build on its own:
> serverRequest "cache build"
["--no-output","--each","--no-output","build.hxml"]

> serverRequest "server/invalidate"
["--display","{\"jsonrpc\":\"2.0\",\"id\":4,\"method\":\"server/invalidate\",\"params\":{\"file\":\"/git/haxe-libs/haxeserver/repro/xredefined/src/CodeBuilder.macro.hx\"}}"]

- displayResponse
> serverRequest "server/contexts"
["--display","{\"jsonrpc\":\"2.0\",\"id\":3,\"method\":\"server/contexts\"}"]

# - assert success
- assert 23 items
- echo "data.args.|"
- displayResponse
> serverRequest "display/completion"
["--cwd","/git/haxe-libs/haxeserver/repro/xredefined","build.hxml","--display","{\"jsonrpc\":\"2.0\",\"id\":36,\"method\":\"display/completion\",\"params\":{\"file\":\"/git/haxe-libs/haxeserver/repro/xredefined/src/CodeBuilder.macro.hx\",\"contents\":\"class CodeBuilder {\\n    var data:FunctionData;\\n\\n    public function new(data:FunctionData) {\\n        this.data = data;\\n    }\\n\\n    public function build():Void {\\n\\t\\tdata.args.\\n    }\\n\\n}\\n\\n@:structInit class FunctionData {\\n\\tpublic final args:Array<String>;\\n}\\n\",\"offset\":173,\"wasAutoTriggered\":true,\"meta\":[\":deprecated\"]}}"]

# - assert success
- assert 23 items
- echo "data.args.|"
- displayResponse
> serverRequest "display/completion"
["--cwd","/git/haxe-libs/haxeserver/repro/xredefined","build.hxml","--display","{\"jsonrpc\":\"2.0\",\"id\":36,\"method\":\"display/completion\",\"params\":{\"file\":\"/git/haxe-libs/haxeserver/repro/xredefined/src/CodeBuilder.macro.hx\",\"contents\":\"class CodeBuilder {\\n    var data:FunctionData;\\n\\n    public function new(data:FunctionData) {\\n        this.data = data;\\n    }\\n\\n    public function build():Void {\\n\\t\\tdata.args.\\n    }\\n\\n}\\n\\n@:structInit class FunctionData {\\n\\tpublic final args:Array<String>;\\n}\\n\",\"offset\":173,\"wasAutoTriggered\":true,\"meta\":[\":deprecated\"]}}"]

- assert fail
- displayResponse
> serverRequest "compilation"
["build.hxml"]

< compilationResult
<<EOF

EOF
